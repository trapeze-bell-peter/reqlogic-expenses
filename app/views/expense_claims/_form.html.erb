<% show_only = local_assigns.fetch :show_only, false %>

<%= form_with(model: expense_claim, local: true, id: 'expense_form') do |expense_form| %>
  <% if expense_claim.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(expense_claim.errors.count, "error") %> prohibited this expense_claim from being saved:</h2>

      <ul>
      <% expense_claim.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group row">
    <%= expense_form.label :description, class:  "col-sm-2 col-form-label" %>
    <div class="col-sm-10">
      <%= expense_form.text_field :description, class: "form-control" %>
    </div>
  </div>

  <div class="form-group row">
    <%= expense_form.label :claim_date, class:  "col-sm-2 col-form-label" %>
    <div class="col-sm-10">
      <%= expense_form.date_field :claim_date %>
    </div>
  </div>

  <div data-controller="expenses">
    <table class="table table-hover">
      <thead>
        <tr class="form-row">
          <th scope="col" class="col-2">Date</th>
          <th scope="col" class="col-2">Category</th>
          <th scope="col" class="col-3">Description</th>
          <th scope="col" class="col-1">Project</th>
          <th scope="col" class="col-1">VAT Rate</th>
          <th scope="col" class="col-1">Qty</th>
          <th scope="col" class="col-1">Unit Cost</th>
          <th scope="col" class="col-1">Cost</th>
        </tr>
      </thead>
      <%= expense_form.fields_for :expense_entries, expense_claim.expense_entries do |expenses_fields| %>
        <tr class="form-row">
          <td class="col-2">
            <%= expenses_fields.date_field :date, class: 'form-control', placeholder: 'Date' %>
          </td>
          <td class="col-2">
            <%= expenses_fields.select :category,
                                       options_for_select(
                                           [['ACCOMODATION', 'ACCOMODATION', {}, { data: { vat: '20%', unitCost: ''} }],
                                            ['FARES', 'FARES', {}, { data: { vat: '0%', unitCost: '10.00'} }]]),
                                       { include_blank: 'Category'},
                                       { class: 'form-control', data: { action: 'change->expenses#categoryChange' } } %>
          </td>
          <td class="col-2">
            <%= expenses_fields.text_field :description, class: 'form-control', placeholder: 'Description' %>
          </td>
          <td class="col-1">
            EXPENSE
          </td>
          <td class="col-1">
            <%= expenses_fields.text_field :vat, class: 'form-control', data: { target: 'expenses.vat' } %>
          </td>
          <td class="col-1">
            <%= expenses_fields.text_field :qty, class: 'form-control', data: { action:'change->expenses#recalcClaim', target: 'expenses.qty'} %>
          </td>
          <td class="col-1">
            <%= expenses_fields.text_field :unit_cost, class: 'form-control', data: { action:'change->expenses#recalcClaim', target: 'expenses.unitCost' } %>
          </td>
          <td class="col-1">
            <input type="text" value="0.0" disabled="true" class="form-control" data-target="expenses.totalCost">
          </td>
          <td class="col-1">
            <i class="fa fa-times" aria-hidden="true"></i>
          </td>
        </tr>
      <% end %>
    </table>
  </div>

  <% if show_only %>
    <script>
        $("#expense_form input").prop("disabled", true);
        $("#expense_form select").prop("disabled", true);
    </script>
  <% else %>
    <div class="form-group row">
      <%= expense_form.submit class: "btn btn-primary" %>
    </div>
  <% end %>
<% end %>
